webpackJsonp([29],{Ly1h:function(t,e){},yXzB:function(t,e,i){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var s=i("3cXf"),r=i.n(s),a=i("aA9S"),o=i.n(a),l=i("Mn3y"),n={plus:i("hSzm"),remove:i("ZRMD"),sort:i("n13j"),ruleConOpen:i("k19Z"),arrowLeft:i("Oglh")},c={name:"pages_stratForm",data:function(){return{pageName:"pages_stratForm",icon:n,show:{stratName:!0,ruleForm:!1},policyList:[],variableList:[],oprList:[{id:1,name:"="},{id:2,name:"!="},{id:3,name:"is null"},{id:4,name:">"},{id:5,name:">="},{id:6,name:"<"},{id:7,name:"<="},{id:8,name:"startsWith"},{id:9,name:"contains"}],oprList_str:[{id:1,name:"="},{id:2,name:"!="},{id:3,name:"is null"},{id:8,name:"startsWith"},{id:9,name:"contains"}],oprList_num:[{id:1,name:"="},{id:2,name:"!="},{id:4,name:">"},{id:5,name:">="},{id:6,name:"<"},{id:7,name:"<="}],oprList_bl:[{id:"1",name:"是"},{id:"0",name:"否"}],hitList:[{id:0,name:"通过"},{id:1,name:"拒绝"},{id:2,name:"人工审核"},{id:3,name:"继续执行"}],stratForm:{nodeId:"",appId:"",policyName:"",rate:"",policyId:"",logic:"",missThen:"",hitThen:"",exceptionThen:"",ruleList:""},vLock:!1,isNewNode:!0,stratLoading:!0,policyListFilter:[],isDisabled:!1}},props:["policyType","appId","variableListUml","policyListUml"],components:{ruleItem:l.a},created:function(){this.variableList=this.variableListUml,this.policyListFilter=this.policyList=this.policyListUml?this.policyListUml:[],this.variableListUml.length&&this.policyList.length?this.initData():this.variableListUml.length?this.getPolicyList():this.getVariableList(!!this.policyList.length),this.stratForm.appId=this.$route.query.appId,"edit"==this.$route.query.type&&(this.stratForm.policyId=this.$route.query.policyId)},methods:{getPolicyList:function(){var t=this;!(arguments.length>0&&void 0!==arguments[0])||arguments[0];this.$post("/mcs/policy/template/list",{appId:this.$route.query.appId,policyName:"",pageNo:"",pageSize:999,statusOrder:2}).then(function(e){t.policyList=e.policyList,t.policyListFilter=e.policyList,t.initData()})},initData:function(){this.$route.name.indexOf("_stratForm")>-1?(this.stratForm.policyId=this.$route.query.policyId,this.stratAdd2()):"stratAdd"==this.$route.name?this.stratAdd():"stratEdit"==this.$route.name?this.getPolicyDetail():this.getPolicyNode(),this.stratLoading=!1},getPolicyNode:function(){var t=this;this.$post("/mcs/node/policy/query",{nodeId:this.$route.query.nodeId.slice(4)}).then(function(e){e&&(t.isNewNode=!e.policyList[0].policyName,t.stratForm.policyId=e.policyList[0].policyId,e.policyList[0].policyName&&(t.show.stratName=!1),e.policyList[0].ruleList.map(function(e,i){e.ruleConShow=!1,e.ruleContent.map(function(e,i){e.sort=i,e.operationArray=e.content.map(function(t){return t.operationValue}),e.oprList=[],t.getVarType(e,i,0)}),e.isTemplate||(e.id=e.ruleName)}),e.policyList[0].ruleList.sort(function(t,e){return t.sort-e.sort}),o()(t.stratForm,e.policyList[0]),"stratForm"==t.$route.name&&t.isNewNode&&t.stratAdd());var i=JSON.parse(r()(t.stratForm));i.nodeName=t.stratForm.policyName,i.nodeId=t.$route.query.nodeId,i.clear=!e})},stratAdd:function(){var t=this;this.$refs.policyName.blur(),this.show.stratName=!1,this.resetStratForm(),this.$nextTick(function(){t.$refs.ruleItem.rule_plus()})},stratAdd2:function(){var t=this;this.$route.query.policyId=this.stratForm.policyId,this.show.stratName=!1,this.resetStratForm(),this.$nextTick(function(){t.$refs.ruleItem.rule_plus()}),this.$route.query.policyType&&(this.stratForm.policyType=this.$route.query.policyType)},arrowLeft:function(){this.$route.name.indexOf("_stratForm")>-1?(this.$router.push({query:this.$route.query}),this.$router.go(-1)):(this.show.stratName=!0,this.$route.query.policyId?(this.stratForm.policyId=this.$route.query.policyId,this.changeStratName(this.$route.query.policyId),delete this.$route.query.policyId):this.stratForm.policyId="")},changeStratName:function(t){var e=this;this.policyList.map(function(i){i.id==t&&(e.stratForm.policyName=i.policyName)}),this.getPolicyDetail(),this.$nextTick(function(){e.show.stratName=!1})},validateStrat:function(){var t=this;this.vLock=!0;var e=this.stratForm.ruleList.filter(function(e){var i=t.$refs.ruleItem.validateRule(e);return!!e.ruleName&&!!e.logic&&i}).length,i=function(){return"stratForm"!=t.$route.name&&"parallelForm_stratForm"!=t.$route.name||!t.stratForm.policyId||""!==t.stratForm.missThen&&""!==t.stratForm.hitThen&&""!==t.stratForm.exceptionThen};return console.log("完整rule",e,"所有rule",this.stratForm.ruleList.length,i()),!!this.stratForm.policyName&&this.stratForm.logic&&e==this.stratForm.ruleList.length&&i()},saveStrat:function(t,e){if(console.log("保存策略按钮>>》",t,e,this.$route.query,this.stratForm,this.$route.name),console.log(this.validateStrat()),this.validateStrat())this.$route.name.indexOf("_stratForm")>-1?this.$emit("createStratSuccess",this.stratForm):"stratAdd"==this.$route.name||"stratEdit"==this.$route.name?t?this.updatePolicy(t):this.createPolicy():"stratForm"==this.$route.name&&(e?this.updatePolicy(t,e):this.stratForm.policyId?this.bindStrat():this.isNewNode?(console.log("创建新的策略， type:",this.stratForm.policyType),this.stratForm.policyId=!0,0==this.stratForm.policyType&&(console.log("创建新的策略模板"),console.log("创建新的策略模板"),this.createPolicy())):(alert(33),console.log("老节点-绑定"),this.bindStrat()));else{var i="";i=""==this.stratForm.policyName?"请输入策略名称":""==this.stratForm.logic?"请选择策略执行条件":"请填写相关必填项",this.$notify({message:i,type:"warning",customClass:"pos-stratForm1"})}},createPolicy:function(){var t=this;this.stratForm.policyType=this.stratForm.policyType?0:this.policyType,this.stratForm.appId=this.appId?this.appId:this.$route.query.appId;var e=JSON.parse(r()(this.stratForm));e.ruleList.map(function(t){t.id=""}),this.$post("/mcs/policy/create",e).then(function(e){t.$message.success("创建成功"),"stratAdd"==t.$route.name||"stratEdit"==t.$route.name?t.$router.push("/risk/stratMg/stratList"):t.stratForm.policyId=!0})},updatePolicy:function(t,e){var i=this,s=JSON.parse(r()(this.stratForm));s.policyId=t,s.newVersion=e||0,s.ruleList.map(function(t,e){t.id=t.id_back}),delete s.appId,delete s.policyType;this.$post("/mcs/policy/update",s).then(function(t){i.$message.success("修改成功"),"stratAdd"==i.$route.name||"stratEdit"==i.$route.name?i.$router.push("/risk/stratMg/stratList"):(s.nodeName=s.policyName,i.$emit("saveForm",s),i.resetStratForm(),i.show.stratName=!0)})},bindStrat:function(){var t=this;this.stratForm.policyType=this.stratForm.policyType?0:this.policyType;if(this.validateStrat()){var e=JSON.parse(r()(this.stratForm));e.nodeId=this.$route.query.nodeId.slice(4),e.ruleList.map(function(t,e){t.id=""});var i=[];if(i.push(e),"kingForm"==this.$route.query.from){var s="{}"!=r()(this.$local.get("policyList"))?this.$local.get("policyList"):[];s.push(e),console.log(s),this.$local.set("policyList",s),this.$router.push(this.$route.fullPath.replace("/stratForm","/kingForm"))}else this.$post("/mcs/node/policy/bind",{nodeId:this.$route.query.nodeId.slice(4),policyList:i}).then(function(i){t.$message.success("绑定成功"),e.nodeName=t.stratForm.policyName,e.nodeId=t.$route.query.nodeId,t.$emit("saveForm",e),t.resetStratForm(),t.show.stratName=!0})}else this.$notify({message:"策略信息不完整",type:"warning",customClass:"pos-stratForm2"})},resetStratForm:function(){this.stratForm={appId:this.$route.query.appId,policyName:"",policyId:"",logic:"",missThen:"",hitThen:"",exceptionThen:"",ruleList:[],policyType:!1,policyShow:!0},this.vLock=!1},getVariableList:function(){var t=this,e=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];this.$post("/mcs/variable/config/list",{appId:this.$route.query.appId}).then(function(i){t.variableList=i.variableList,e&&t.getPolicyList(!1),t.initData()})},getPolicyDetail:function(){var t=this;this.show.stratName=!1,this.$post("/mcs/policy/query",{id:this.stratForm.policyId}).then(function(e){console.log(e),e.ruleList.map(function(e,i){e.ruleConShow=!1,e.ruleContent.map(function(e,i){e.sort=i,e.operationArray=e.content.map(function(t){return t.operationValue}),e.oprList=[],t.getVarType(e,i,0)})}),e.ruleList.sort(function(t,e){return t.sort-e.sort}),console.log(e),delete e.appId,o()(t.stratForm,e)})},ruleAdd:function(){this.$router.push({path:this.$route.path+"/ruleForm",query:this.$route.query})},pushRule:function(t){console.log("策略中新增规则"),this.stratForm.ruleList=this.stratForm.ruleList.filter(function(t){return!!t.ruleName}),console.log("保存规则到策略模板",this.$route.query),t.id=t.ruleName,this.$refs.ruleItem.ruleTmplList.push(t),this.stratForm.ruleList.push(t),this.$router.push({query:this.$route.query}),this.$router.go(-1)},getVarType:function(t,e,i){var s=this;this.variableList.map(function(r){t.variableId==r.variableId&&(t.variableName=r.variableName,t.variableType=r.variableType,1==r.variableType?t.oprList=s.oprList_str:2==r.variableType||3==r.variableType||4==r.variableType?t.oprList=s.oprList_num:5==r.variableType?s.getOprList_enumList(t,e,i):6==r.variableType?t.oprList=s.oprList_bl:s.$notify({message:"未知变量",type:"warning"}))})},getOprList_enumList:function(t,e,i){this.$post("/mcs/variable/enums",{variableId:t.variableId}).then(function(e){e.enumList.map(function(t){t.id=t.enumValue,t.name=t.enumName}),t.oprList=e.enumList})},operation:function(t){switch(t){case 1:return"=";case 2:return"!=";case 3:return"is null";case 4:return">";case 5:return">=";case 6:return"<";case 7:return"<=";case 8:return"startsWith";case 9:return"contains"}}}},m={render:function(){var t=this,e=t.$createElement,i=t._self._c||e;return i("div",{directives:[{name:"loading",rawName:"v-loading",value:t.stratLoading,expression:"stratLoading"}],staticClass:"pages_stratForm"},[i("div",{directives:[{name:"show",rawName:"v-show",value:-1==t.$route.name.indexOf("_ruleForm"),expression:"$route.name.indexOf('_ruleForm')==-1"}]},[t.show.stratName?i("el-form",{ref:"stratName",staticClass:"stratName",attrs:{model:t.stratForm,"status-icon":""}},[i("el-form-item",{attrs:{label:""}},[i("el-select",{ref:"policyName",staticClass:"w310",attrs:{filterable:"",placeholder:"请选择已有的策略模版",size:"medium","no-match-text":"查询无结果","no-data-text":"暂无数据","popper-class":t.policyListFilter.length?"stratList toNew hasData":"stratList toNew"},on:{change:t.changeStratName},model:{value:t.stratForm.policyId,callback:function(e){t.$set(t.stratForm,"policyId",t._n(e))},expression:"stratForm.policyId"}},[t._l(t.policyListFilter,function(e,s){return i("el-option",{key:s,attrs:{label:e.policyName,value:e.id,disabled:"2"==e.policyStatus}},[i("div",{staticClass:"stratOption overhide",attrs:{title:e.policyName}},[t._v(t._s(e.policyName))])])}),t._v(" "),i("div",{staticClass:"stratAdd f_blue pointer mg_l_20 toNewBtn",on:{click:t.stratAdd}},[t._v("+新建策略")])],2)],1)],1):i("el-form",{ref:"stratForm",staticClass:"stratForm",attrs:{model:t.stratForm,"status-icon":""}},["stratAdd"==t.$route.name||!t.$route.query.moldType&&"stratEdit"==t.$route.name?t._e():i("img",{staticClass:"backTostratName pointer",attrs:{src:t.icon.arrowLeft,alt:"返回策略名称"},on:{click:t.arrowLeft}}),t._v(" "),i("el-form-item",{attrs:{label:""}},["look"==t.$route.query.type?i("div",{staticClass:"w300 overhide"},[t._v("\n                    "+t._s(t.stratForm.policyName)+"\n                ")]):i("el-input",{staticClass:"w310",class:{solid_red:t.vLock&&!t.stratForm.policyName},attrs:{placeholder:"请输入策略名称",size:"medium",clearable:""},model:{value:t.stratForm.policyName,callback:function(e){t.$set(t.stratForm,"policyName",e)},expression:"stratForm.policyName"}})],1),t._v(" "),"stratForm"!=t.$route.name&&"parallelForm_stratForm"!=t.$route.name||!t.stratForm.policyId?t._e():i("div",{staticClass:"stratForm_sug"},[i("p",{staticClass:"sug_title"},[t._v("决策意见：")]),t._v(" "),i("el-form-item",{staticClass:"inlineBlock missThen",attrs:{label:"策略未命中","label-width":"80px"}},[i("el-select",{staticClass:"w150",class:{solid_red:t.vLock&&""===t.stratForm.missThen},attrs:{disabled:"look"==t.$route.query.type,placeholder:"请选择",size:"medium","no-match-text":"查询无结果","no-data-text":"暂无数据","popper-class":"hitList"},model:{value:t.stratForm.missThen,callback:function(e){t.$set(t.stratForm,"missThen",t._n(e))},expression:"stratForm.missThen"}},t._l(t.hitList,function(t,e){return i("el-option",{key:e,attrs:{label:t.name,value:t.id}})}))],1),t._v(" "),i("el-form-item",{staticClass:"inlineBlock hitThen",attrs:{label:"策略命中","label-width":"95px"}},[i("el-select",{staticClass:"w150",class:{solid_red:t.vLock&&""===t.stratForm.hitThen},attrs:{disabled:"look"==t.$route.query.type,placeholder:"请选择",size:"medium","no-match-text":"查询无结果","no-data-text":"暂无数据","popper-class":"hitList"},model:{value:t.stratForm.hitThen,callback:function(e){t.$set(t.stratForm,"hitThen",t._n(e))},expression:"stratForm.hitThen"}},t._l(t.hitList,function(t,e){return i("el-option",{key:e,attrs:{label:t.name,value:t.id}})}))],1),t._v(" "),i("el-form-item",{staticClass:"inlineBlock exceptionThen",attrs:{label:"异常","label-width":"66px"}},[i("el-select",{staticClass:"w150",class:{solid_red:t.vLock&&""===t.stratForm.exceptionThen},attrs:{disabled:"look"==t.$route.query.type,placeholder:"请选择",size:"medium","no-match-text":"查询无结果","no-data-text":"暂无数据","popper-class":"hitList"},model:{value:t.stratForm.exceptionThen,callback:function(e){t.$set(t.stratForm,"exceptionThen",t._n(e))},expression:"stratForm.exceptionThen"}},t._l(t.hitList,function(t,e){return i("el-option",{key:e,attrs:{label:t.name,value:t.id}})}))],1)],1),t._v(" "),i("div",{staticClass:"stratForm_rule mg_t_20"},[i("el-form-item",{attrs:{label:"策略执行条件：",prop:"logic"}},[i("el-radio-group",{class:{solid_red:t.vLock&&!t.stratForm.logic},model:{value:t.stratForm.logic,callback:function(e){t.$set(t.stratForm,"logic",t._n(e))},expression:"stratForm.logic"}},["look"!=t.$route.query.type||2==t.stratForm.logic?i("el-radio",{attrs:{label:2}},[t._v("满足任意条件\n                        ")]):t._e(),t._v(" "),"look"!=t.$route.query.type||1==t.stratForm.logic?i("el-radio",{attrs:{label:1}},[t._v("满足全部条件\n                        ")]):t._e()],1)],1),t._v(" "),i("el-form-item",{staticClass:"stratForm_bd"},[i("ruleItem",{ref:"ruleItem",attrs:{icon:t.icon,variableList:t.variableList,ruleTmplListUml:[],ruleList:t.stratForm.ruleList,show:t.show,vLock:t.vLock,appId:t.appId},on:{getVarType:t.getVarType}})],1),t._v(" "),"stratAdd"==t.$route.name||"stratEdit"==t.$route.name||t.stratForm.policyId?t._e():i("el-form-item",{staticClass:"policyType",attrs:{label:""}},[i("el-checkbox",{attrs:{"true-label":"0","false-label":"1"},model:{value:t.stratForm.policyType,callback:function(e){t.$set(t.stratForm,"policyType",e)},expression:"stratForm.policyType"}},[t._v("保存为策略模板")])],1)],1),t._v(" "),t.stratForm.policyId&&"look"!=t.$route.query.type?i("div",{staticClass:"text-center"},[i("el-button",{attrs:{type:"primary",size:"medium"},on:{click:function(e){t.saveStrat("edit"==t.$route.query.type?t.stratForm.id:t.stratForm.appId)}}},[t._v("保存\n                ")])],1):"look"!=t.$route.query.type?i("div",{staticClass:"text-center"},[i("el-button",{attrs:{type:"primary",size:"medium"},on:{click:function(e){t.saveStrat()}}},[t._v("保存")])],1):t._e()],1)],1),t._v(" "),i("router-view",{attrs:{icon:t.icon,variableList:t.variableList,appId:t.appId},on:{createRuleSuccess:t.pushRule,getVarType:t.getVarType}})],1)},staticRenderFns:[]};var p=i("C7Lr")(c,m,!1,function(t){i("Ly1h")},null,null);e.default=p.exports}});