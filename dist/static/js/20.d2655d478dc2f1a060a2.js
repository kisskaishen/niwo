webpackJsonp([20],{"2fwv":function(e,t){},"5rQp":function(e,t,i){"use strict";i.d(t,"a",function(){return a});var n=i("3cXf"),s=i.n(n),o=i("IvJb"),a={data:function(){var e=this;return{ajax:{createNode:function(t){e.$post("/mcs/node/create",{moldId:e.$route.query.modelId,nodeName:t.nodeName,nodeType:t.nodetype,positionLeft:t.positionLeft.slice(0,-2),positionTop:t.positionTop.slice(0,-2)}).then(function(i){e.createNode(t),e.checkOnlyNode()})},updateNode:function(t){e.$post("/mcs/node/update",{id:t.id.slice(4),nodeName:t.nodeName,positionLeft:t.positionLeft.slice(0,-2),positionTop:t.positionTop.slice(0,-2)}).then(function(i){document.querySelector("#"+t.id+">.uml_title").innerText=t.nodeName.replace(/[\n\s*\r]/g,""),document.getElementById(t.id).style.left=t.positionLeft,document.getElementById(t.id).style.top=t.positionTop,e.checkOnlyNode(),setTimeout(function(){jsPlumb.repaintEverything()},100)})},bindNode:function(t){var i=JSON.parse(s()(t.formData));i.nodeId=i.nodeId.slice(4),i.policyList&&i.policyList.map(function(e){e.ruleList.map(function(e){return e.id=""})}),i.ruleList&&i.ruleList.map(function(e){return e.id=""}),e.$post(e.dom.oprOpp[t.nodetype],i).then(function(i){e.$message.success("更新成功"),e.updateNodeName(t.formData,!1),e.checkOnlyNode()})},deleteNode:function(t){e.$post("/mcs/node/delete",{id:t.id.slice(4)}).then(function(i){jsPlumb.remove(t.id),e.checkOnlyNode()})},recoveryNode:function(t){e.$post("/mcs/node/recovery",{nodeId:t.id.slice(4),lineIdList:t.lines.map(function(e){return e.id})}).then(function(i){e.createNode(t),e.checkOnlyNode(),t.lines.length&&t.lines.map(function(t){e.createConnection(t)})})},updateLine:function(t){console.log("ajax更新连线中……",t),e.$post("/mcs/node/line/update",{id:t.lineId,lineValue:t.lineValue,valueDescription:t.valueDescription}).then(function(i){jsPlumb.getConnections().map(function(i,n){i.id==t.lineId&&e.updateNodeName(t,!1)})})},deleteLine:function(t){e.$post("/mcs/node/line/delete",{id:t.id}).then(function(e){jsPlumb.getConnections().map(function(e,i){t.id==e.id&&(console.log("删除连线中……",e.endpoints,e),jsPlumb.deleteConnection(e))})})},recoveryLine:function(t){e.$post("/mcs/node/line/recovery",{id:t.id}).then(function(i){e.createConnection(t)})}},ajaxPush:{updateNode:function(t){e.$post("/mcs/node/update",{id:t.id.slice(4),nodeName:t.nodeName,positionLeft:t.positionLeft.slice(0,-2),positionTop:t.positionTop.slice(0,-2)}).then(function(i){e.pushUpdate(e.tmp.initForm,t),e.tmp.initForm={},setTimeout(function(){jsPlumb.repaintEverything()},50)})},deleteNode:function(t){e.$post("/mcs/node/delete",{id:t.id.slice(4)}).then(function(i){e.pushNode(t,"delete"),e.checkOnlyNode(),setTimeout(function(){jsPlumb.remove(t.id)},100)})},createLine:function(t){e.nodeDirect.indexOf(t.endpoints[1].anchor.type)>-1&&(console.log("创建连线中……",t.id,t.canvas.dataset,-1==t.id.indexOf("con_")),e.$post("/mcs/node/line/create",{moldId:e.$route.query.modelId,startNodeId:t.sourceId.slice(4),startNodeDirect:e.nodeDirect.indexOf(t.endpoints[0].anchor.type),endNodeId:t.targetId.slice(4),endNodeDirect:e.nodeDirect.indexOf(t.endpoints[1].anchor.type)}).then(function(i){t.id=i.id,console.log("ajaxPush.createLine",t.id,i.id,t.canvas.dataset),e.pushLine(t,"create")}))},updateLine:function(t){e.$post("/mcs/node/line/update",{id:t.lineId,lineValue:t.lineValue,valueDescription:t.valueDescription}).then(function(i){e.pushUpdate(e.tmp.initForm,t),e.tmp.initForm={}})},updateLine2:function(t){console.log(t.canvas.dataset),console.log(t.canvas.dataset.des),o.default.prototype.$post("/mcs/node/line/update",{id:t.id,lineValue:t.canvas.dataset.linevalue,valueDescription:t.canvas.dataset.des}).then(function(i){e.pushUpdate(e.tmp.initForm,t),e.tmp.initForm={}})},deleteLine:function(t){jsPlumb.getConnections().map(function(i,n){t.id==i.id&&e.$post("/mcs/node/line/delete",{id:t.id}).then(function(i){e.pushLine(t,"delete"),jsPlumb.deleteConnection(t)})})}}}},methods:{pushNode:function(e,t){var i=this.getNodeData(e,t,{});this.dom.push(t,i,this)},pushLine:function(e,t){var i=this.getLineData(e,t,{});this.dom.push(t,i,this)},pushBind:function(e,t){t=JSON.parse(s()(t));var i=this.getBindData(t);this.dom.multiPush("bind",e,i,this)},pushUpdate:function(e,t){t=JSON.parse(s()(t)),this.dom.multiPush("update",e,t,this)},getNodeData:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"",i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};return{id:e.id,nodeName:document.querySelector("#"+e.id+">.uml_title").innerText.replace(/[\n\s*\r]/g,""),positionLeft:e.style.left,positionTop:e.style.top,nodetype:e.dataset.nodetype,nodeType:e.dataset.nodetype,oprtype:t,formData:i,clear:!!e.clear,lines:this.getNodeLines(e)}},getNodeLines:function(e){var t=this;return jsPlumb.getConnections().filter(function(t){return t.sourceId==e.id||t.targetId==e.id}).map(function(e){return t.getLineData(e)})},getBindData:function(e){var t=void 0;return t=this.selected.event.canvas?this.selected.event.canvas:this.selected.event.target,{id:e.nodeId,nodeName:e.nodeName,positionLeft:t.style?t.style.left:"",positionTop:t.style?t.style.top:"",nodetype:t.dataset.nodetype,nodeType:t.dataset.nodetype,oprtype:"bind",formData:e,clear:!!e.clear}},getLineData:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"",i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};return{id:e.id,startNodeDirect:e.canvas.dataset.startNodeDirect?e.canvas.dataset.startNodeDirect:"",startNodeId:e.sourceId,endNodeDirect:e.canvas.dataset.endNodeDirect?e.canvas.dataset.endNodeDirect:"",endNodeId:e.targetId,lineValue:e.canvas.dataset.linevalue?e.canvas.dataset.linevalue:"",valueDescription:e.canvas.dataset.des?e.canvas.dataset.des:"",oprtype:t,formData:i,nodetype:"line",nodeType:"line",allowrevoke:e.canvas.dataset.allowrevoke}}}}},GR5D:function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var n=i("aA9S"),s=i.n(n),o=i("3cXf"),a=i.n(o),l=i("5rQp"),c={name:"pages_classifyForm",data:function(){return{loading:!0,pageName:"pages_classifyForm",show:{},rules:{},classifyForm:{nodeId:"",nodeName:"",categoryName:"分类器",policyList:[]},vLock:!1,isNewNode:!0,variableList:[],ruleTmplList:[],allEnmuList:[],oprList:[{id:1,name:"="},{id:2,name:"!="},{id:3,name:"is null"},{id:4,name:">"},{id:5,name:">="},{id:6,name:"<"},{id:7,name:"<="},{id:8,name:"startsWith"},{id:9,name:"contains"}],oprList_str:[{id:1,name:"="},{id:2,name:"!="},{id:3,name:"is null"},{id:8,name:"startsWith"},{id:9,name:"contains"}],oprList_num:[{id:1,name:"="},{id:2,name:"!="},{id:4,name:">"},{id:5,name:">="},{id:6,name:"<"},{id:7,name:"<="}],oprList_bl:[{id:"1",name:"是"},{id:"0",name:"否"}]}},props:["variableListUml","ruleTmplListUml"],components:{policyItem:i("+5dV").a},created:function(){this.variableList=this.variableListUml,this.ruleTmplList=this.ruleTmplListUml,this.getClassifyNode()},methods:{classify_plus:function(e){this.classifyForm.policyList.splice(e+1,0,{appId:"",id:"",policyName:"",logic:"",ruleList:[{id:"",ruleName:"",decisionCode:"",logic:"",ruleConShow:!0,ruleContent:[{variableId:"",variableName:"",variableType:"",logic:1,oprList:[],operationArray:[],content:[{operation:"",operationValue:"",valueDescription:"",sort:""}]}]}],policyShow:!0})},classify_remove:function(e,t){jsPlumb.getConnections().length&&jsPlumb.getConnections().some(function(t){jsPlumb.getConnections().map(function(e){e.canvas.dataset.bdcolor=""});var i=t.canvas.dataset.linevalue&&t.canvas.dataset.linevalue==e.id;return i&&(t.canvas.dataset.bdcolor="red"),i})?this.$notify({message:"删除失败，请先删除分类线条。",type:"warning"}):(this.classifyForm.policyList.splice(t,1),this.classifyForm.policyList.length<1&&(this.classify_plus(e,t),!e.policyName&&this.$notify({message:"不能再删了",type:"warning"})))},validateClassifyForm:function(){var e=this;this.vLock=!0;var t=this.classifyForm.policyList.filter(function(t){var i=!t.policyShow||e.$refs.policyItem.validateStrat(t);return t.policyName&&i}).length;return console.log("完整Classify",t,"所有Classify",this.classifyForm.policyList.length),!!this.classifyForm.categoryName&&t==this.classifyForm.policyList.length},reNameLineLable:function(e){jsPlumb.getConnections().map(function(t){t.canvas.dataset.linevalue==e.id&&(t.canvas.dataset.des=e.policyName,t.getOverlay("label").setLabel(e.policyName))})},bindCategory:function(){var e=this,t=JSON.parse(a()(this.classifyForm));if(console.log(t),t.nodeId=this.$route.query.nodeId.slice(4),t.policyList.map(function(e,t){e.ruleList.map(function(e,t){e.id=""})}),this.validateClassifyForm()){this.$post("/mcs/node/category/bind",t).then(function(i){e.$message.success("绑定成功"),t.nodeName=e.classifyForm.categoryName,t.nodeId=e.$route.query.nodeId,e.updateLineValue(t),e.$emit("saveForm",t),e.resetClassifyForm()})}else{var i="";t.policyList.map(function(e){i=""==e.policyName?"已有变量名":""==e.logic?"逻辑运算符":"信息"}),this.$notify({message:"分类器"+i+"必填",type:"warning",customClass:"pos-classifyForm"})}},resetClassifyForm:function(){this.classifyForm={categoryName:"",policyList:[]},this.classify_plus(),this.vLock=!1},updateLineValue:function(e){var t=this;e&&(console.log(e),e.policyList.map(function(t,i){e.policyList[i]&&(t.oldId=e.policyList[i].id,t.policyName=e.policyList[i].policyName)}),jsPlumb.getConnections().map(function(i){e.policyList.map(function(e,t){console.log(t,i.canvas.dataset.linevalue,e.oldId),i.canvas.dataset.linevalue==e.oldId&&(console.log("【更新线条ID】","现:",i.canvas.dataset.linevalue,"缓存:",e.oldId,"新:",e.id),i.canvas.dataset.linevalue=e.id,i.canvas.dataset.des=e.policyName,console.log(i),l.a.data().ajaxPush.updateLine2(i))}),"1"==i.canvas.dataset.selected&&(t.$route.query.lineValue=i.canvas.dataset.linevalue)}))},getClassifyNode:function(){var e=this;this.$post("/mcs/node/category/query",{nodeId:this.$route.query.nodeId.slice(4)}).then(function(t){t&&t.policyList?(t.policyList.map(function(t){t.policyShow=!1,t.ruleList.map(function(t,i){t.ruleConShow=!1,t.ruleContent.map(function(t,i){t.sort=i,t.operationArray=t.content.map(function(e){return e.operationValue}),t.oprList=[],e.getVarType(t,i,0)}),t.isTemplate||(t.id=t.ruleName)})}),s()(e.classifyForm,t)):e.classify_plus();var i=JSON.parse(a()(e.classifyForm));i.nodeName=e.classifyForm.categoryName,i.nodeId=e.$route.query.nodeId,i.clear=!t,e.$emit("firstBindPush",i),e.loading=!1})},stratAdd:function(){var e=this.$route.query;e.policyType=2,this.$router.push({path:"/risk/modelMg/modelUml/classifyForm/stratForm",query:e})},pushStrat:function(e){this.classifyForm.policyList=this.classifyForm.policyList.filter(function(e){return!!e.policyName}),this.classifyForm.policyList.push(e),this.$router.push({path:"/risk/modelMg/modelUml/classifyForm",query:this.$route.query})},getVarType:function(e,t,i){var n=this;this.allEnmuList=this.$refs.policyItem.allEnmuList,this.variableList.map(function(t){e.variableId==t.variableId&&(e.variableName=t.variableName,e.variableType=t.variableType,1==t.variableType?e.oprList=n.oprList_str:2==t.variableType||3==t.variableType||4==t.variableType?e.oprList=n.oprList_num:5==t.variableType?(e.oprList=[],n.allEnmuList.map(function(t){e.variableId==t.variableId&&(t.id=t.enumValue,t.name=t.enumName,e.oprList.push(t),console.log(e.oprList))})):6==t.variableType?e.oprList=n.oprList_bl:n.$notify({message:"未知变量",type:"warning"}))})},getOprList_enumList:function(){var e=this;this.$post("/mcs/variable/enum/list",{}).then(function(t){e.allEnmuList=t.enumList})}}},r={render:function(){var e=this,t=e.$createElement,i=e._self._c||t;return i("div",{staticClass:"pages_classifyForm"},[i("el-form",{directives:[{name:"show",rawName:"v-show",value:"classifyForm"==e.$route.name,expression:"$route.name=='classifyForm'"}],staticClass:"classifyForm",attrs:{model:e.classifyForm,"status-icon":"",rules:e.rules}},[i("el-form-item",{attrs:{label:""}},["look"==e.$route.query.type?i("div",{staticClass:"w300 overhide"},[e._v("\n                "+e._s(e.classifyForm.categoryName)+"\n            ")]):i("el-input",{staticClass:"w310",class:{solid_red:e.vLock&&!e.classifyForm.categoryName},attrs:{placeholder:"请输入分类器名称",size:"medium",clearable:""},model:{value:e.classifyForm.categoryName,callback:function(t){e.$set(e.classifyForm,"categoryName",t)},expression:"classifyForm.categoryName"}})],1),e._v(" "),i("div",{staticClass:"defaultClassify mg_b_20"},[e._v("默认分类：其他")]),e._v(" "),i("div",{staticClass:"classifyForm_bd"},[i("policyItem",{ref:"policyItem",attrs:{classifyForm:e.classifyForm,vLock:e.vLock,variableListUml:e.variableList,ruleTmplListUml:e.ruleTmplList},on:{classify_plus:e.classify_plus,classify_remove:e.classify_remove}})],1),e._v(" "),i("div",{staticClass:"mg_t_20"},["look"!=e.$route.query.type?i("el-button",{attrs:{type:"primary",size:"medium"},on:{click:function(t){e.bindCategory()}}},[e._v("保存\n            ")]):e._e()],1)],1),e._v(" "),i("router-view",{attrs:{variableListUml:e.variableList,ruleTmplListUml:e.ruleTmplList},on:{createStratSuccess:e.pushStrat}})],1)},staticRenderFns:[]};var d=i("C7Lr")(c,r,!1,function(e){i("2fwv")},null,null);t.default=d.exports}});